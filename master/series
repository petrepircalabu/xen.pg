#
# XenServer patch queue on top of xen.git branch stable-4.5
#    Upstream at git://xenbits.xen.org/xen.git
#
# In an effort to reduce future work of upgrading Xen versions, all patches in
# this queue require a justification as to why they can't/won't be upstreamed,
# with the implication that everything else should be upstreamed.
#
# If in any doubt, the ring0 patch queue maintainer will be happy to help.
#
# All patches should follow the guidelines listed here:
#       http://wiki.xen.org/wiki/Submitting_Xen_Patches
# in particular with respect to a description and S-o-b lines, with the
# exception of temporary debugging patches, which should contain at least a CA
# reference.
#
# Overview of sections:
# * XenServer build system integration.
#       **Minimal Upstream makefile hacks**
# * Upstream patches.
#       Verbatim patches from upstream, possibly with tweaks because of backporting
#       Typically from staging-4.5 and master
# * Patches which are upstream but hard to backport.
#       Only if upstream has diverged enough.  Hopefully empty
# * Patches for upstream.
#       Most patches should be in this section, especially new ones.  By using
#       this section, you are assuming responsibility for getting the patches
#       included upstream, and will be periodically chased by the patch queue
#       maintainer.
# * Un-upstreamable patches.
#       CC-mode restrictions etc.  Should be minimal.
# * Technical debt.
#       Legacy patches brought forward from the past.  This section should
#       never increase, and should progressively decrease.  **Remove when empty**
# * Debugging patches.
#       Temporary debugging patches, which must contain a CA reference.  Before
#       closing a ticket, you are expected to remove debugging patches.

# This needs to be removed in a migrate-safe way
revert-ca2eee92df44.patch # 2008-09-30 09:14:54 - x86, hvm: Expose host core/HT topology to HVM guests.

################################################################################
# XenServer build system integration
#
build-disable-qemu-trad.patch # Disable the qemu trad build while still letting the tools think it exists
build-tweaks.patch # Tweak version string, start-of-day banner and changeset

configure-build.patch # Configuration files for the build, including cached ./configure
builder-makefiles.patch # XS Makefile and Spec file
xenserver-configuration.patch
coverity-model.patch

################################################################################
# Upstream patches
#
# Naming scheme: backport-<12 digit SHA>.patch # [*] <UTC TIMESTAMP> - <Commit subject>
#   A '*' indicates a patch which should be suggested for backport upstream

# Patches from staging-4.5

# Patches from master
backport-780f119c8b07.patch #   2015-09-09 14:27:24 - x86: clean up vm_event-related code in asm-x86/domain.h
backport-6c421a12ea1a.patch #   2015-09-23 09:15:05 - x86: record xsave features in c->x86_capabilities
backport-3a1238d7cb73.patch #   2015-09-28 15:29:45 - fine grained control of REP emulation optimizations
backport-975efd3baa8d.patch #   2015-09-30 12:46:32 - introduce VM_EVENT_FLAG_SET_REGISTERS
backport-bf87f3a24f25.patch #   2015-10-07 11:26:25 - tools/libxc: Improve efficiency of xc_cpuid_apply_policy()
backport-8e3352222b45.patch #   2015-10-08 09:19:28 - efi: split out efi_init()
backport-43e6ee132d0e.patch #   2015-10-08 09:21:45 - efi: split out efi_console_set_mode()
backport-9fd08b427a0f.patch #   2015-10-08 09:22:52 - efi: split out efi_get_gop()
backport-0c36226f41a5.patch #   2015-10-08 09:23:28 - efi: split out efi_find_gop_mode()
backport-0dd7e37832f7.patch #   2015-10-08 09:24:00 - efi: split out efi_tables()
backport-c890487659ca.patch #   2015-10-08 09:24:31 - efi: split out efi_variables()
backport-af79880d358d.patch #   2015-10-08 09:25:09 - efi: split out efi_set_gop_mode()
backport-2fe4c0060c62.patch #   2015-10-08 09:26:37 - efi: split out efi_exit_boot()
backport-42940c046902.patch #   2015-10-12 14:01:56 - x86/shadow: Fix missing newline in dprintk()

################################################################################
# Patches which are upstream but hard to backport
#

################################################################################
# Patches for upstream
#
detect-nehalem-c-state.patch # malcolmc
fix-xsave-dependent-CPUID-bits-being-advertised-to-guests.patch # malcolmc

# dvrabel - v1 posted
0001-trace-include-timestamp-in-trace-records-added-by-HV.patch
0002-trace-allow-HVMOP_xentrace-to-set-trace-record-subcl.patch

# Hpet improvements v5
0001-x86-hpet-Pre-cleanup.patch
0002-x86-hpet-Use-singe-apic-vector-rather-than-irq_descs.patch
0003-x86-hpet-Post-cleanup.patch

0002-libxc-retry-shadow-ops-if-EBUSY-is-returned.patch

# Grant perf improvements
avoid-gnt-unmap-tlb-flush-if-not-accessed.patch

# Multiboot2 + EFI (from Daniel Kiper)
0002-x86-boot-reloc-create-generic-alloc-and-copy-functio.patch
0003-x86-boot-use-ecx-instead-of-eax.patch
0004-xen-x86-add-multiboot2-protocol-support.patch
0005-efi-split-efi_enabled-to-efi_platform-and-efi_loader.patch
0007-efi-run-EFI-specific-code-on-EFI-platform-only.patch
0008-efi-build-xen.gz-with-EFI-code.patch
0017-x86-efi-create-new-early-memory-allocator.patch
0018-x86-add-multiboot2-protocol-support-for-EFI-platform.patch
mkelf32-fixup.patch
0001-x86-efi-Find-memory-for-trampoline-relocation-if-nec.patch
0002-efi-Ensure-incorrectly-typed-runtime-services-get-ma.patch
0001-Fix-compilation-on-CentOS-7.1.patch

0001-x86-HVM-Avoid-cache-flush-operations-during-hvm_load.patch # rossla - CA-168080
0001-libxl-Don-t-insert-PCI-device-into-xenstore-for-HVM-.patch # rossla - CA-168029

x86-only-check-for-one-watchdog-nmi.patch

# CR4 handling - andrewcoop
0001-x86-pv-Rework-CR4-handling-for-PV-guests.patch
0002-x86-pv-Infrastructure-for-32bit-PV-guest-SMAP-workar.patch
0003-x86-pv-smap-fixup-workaround-for-32bit-PV-guests.patch

# PoD extra mitigations
0001-x86-PoD-Command-line-option-to-prohibit-any-PoD-oper.patch
0001-x86-PoD-Restrict-PoD-to-dom0.patch

################################################################################
# Un-upstreamable patches
#
xen-tweak-cmdline-defaults.patch
xen-tweak-debug-overhead.patch
cc-restrictions.patch
tweak-iommu-errata-policy.patch

# Un-upstreamable hacks to make older windows VMs continue to function on newer Xen
xen-legacy-win-driver-version.patch
xen-legacy-win-xenmapspace-quirks.patch
xen-legacy-32bit_shinfo.patch
xen-legacy-process-dying.patch
xen-legacy-viridian-hypercalls.patch
xen-legacy-hvm-console.patch

################################################################################
# Technical debt
#

# xen debt
xen-dont-hide-vtx-or-svm.patch # for xenrt.  Very unsafe :(
xen-define-offsets-for-kdump.patch
xen-scheduler-auto-privdom-weight.patch
xen-hvm-disable-tsc-ramping.patch
xen-hvm-hide-nx.patch
xen-capture-boot-cpuid-info.patch
xen-apply-cpuid-mask-to-cpuid-faulting.patch
xen-disable-xsave.patch # default xsave to off (like 4.1).  Needs CP-4312 to fix Ubuntu 12.04 properly
xen-hide-fma4-on-amd-fam15h.patch # disable FMA4 if xsave is disabled.  For Ubuntu 12.04 on AMD
xen-default-cpufreq-governor-to-performance-on-intel.patch

# libxc debt
libxc-stubs-hvm_check_pvdriver.patch
libxc-ext-6.patch
libxc-ext-7.patch
libxc-ext-8.patch
restrict-privcmd.patch

# libxl debt
libxl-tap-device-name.patch
xl-info-specific.patch # End result considered acceptable upstream.  Implementation might need redoing in 4.5 dev window.

# pygrub debt
pygrub-add-default-and-extra-args.patch
pygrub-always-boot-default.patch
pygrub-friendly-no-fs.patch
pygrub-image-max-size.patch
pygrub-default-xenmobile-kernel.patch
pygrub-blacklist-support.patch

# BIOS debt
oem-bios-xensource.patch # Can probably all be discarded
oem-bios-magic-from-xenstore.patch # Need to tweak, but should be upstreamed

# misc debt
misc-log-guest-consoles.patch
fix-ocaml-libs.patch

# mixed between components
mixed-domain-runstates.patch
mixed-xc-sockets-per-core.patch
mixed-cpuid-before-mask.patch
xenguest.patch
xen-vmdebug.patch
local-xen-vmdebug.patch

oxenstore-customize.patch
oxenstore-update.patch
oxenstore-censor-sensitive-data.patch
oxenstore-large-packets.patch

# vGPU
nvidia-hypercalls.patch
nvidia-vga.patch

# workspace pod debt
hvmloader-disable-pci-option-rom-loading.patch

# Intel GPU passthrough debt - future GPU driver changes will obsolete patch
# Patch is required to allow Cream to Dundee upgrade
igd_passthru.patch
add-p2m-write-dm-to-ram-types.patch
upstream-pv-iommu.patch
upstream-pv-iommu-tools.patch
disable_AMD_pv-iommu.patch
increase-domctl-memory-mapping-limit.patch #  Malcolm to upstream 

# Intel GVT-g debt
0007-hypercall-XENMEM_get_mfn_from_pfn.patch # Remove when PV-IOMMU code merged
0012-resize-MAX_NR_IO_RANGES-to-512.patch # Replace with list discussed version when merged
0014-vgt-add-support-of-emulating-SSE2-instruction-MOVD.patch # Paul to upstream
0015-xen-introduce-unlimited-rangeset.patch # Replace with list discussed version when merged
0016-ioreq-server-allocate-unlimited-rangeset-for-memory-.patch # Replace with list discussed version when merged
gvt-g-hvmloader+rombios.patch # Intel to upstream
ioreq-server-shutdown-fixes.patch # Paul to upstream

create-ident-rmrr-mapping-no-share-pt-hvm.patch

# VM Introspection Extensions
xen-introduce-cmdline-to-control-introspection-extensions.patch
xen-domctl-set-privileged-domain.patch
xen-Support-for-VMCALL-mem_events.patch
xen-reexecute-instn-under-monitor-trap.patch

# Per cpu rwlocks
per-cpu-readlock.patch
use-percpu-rwlock-for-grant-table.patch

################################################################################
# Debugging patches
#
