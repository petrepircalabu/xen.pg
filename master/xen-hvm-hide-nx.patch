Allow NX support to be hidden from HVM guests as a domain creation
parameter.

diff --git a/xen/arch/x86/hvm/hvm.c b/xen/arch/x86/hvm/hvm.c
index 8c42e62..c3c70fa 100644
--- a/xen/arch/x86/hvm/hvm.c
+++ b/xen/arch/x86/hvm/hvm.c
@@ -2998,6 +2998,14 @@ int hvm_set_efer(uint64_t value)
         return X86EMUL_EXCEPTION;
     }
 
+    if ( (value & EFER_NX) &&
+         !(v->domain->arch.hvm_domain.params[HVM_PARAM_NX_ENABLED]) )
+    {
+        gdprintk(XENLOG_WARNING, "Trying to set NXE when it was disabled\n");
+        hvm_inject_page_fault(0, 0);
+        return X86EMUL_EXCEPTION;
+    }
+
     if ( ((value ^ v->arch.hvm_vcpu.guest_efer) & EFER_LME) &&
          hvm_paging_enabled(v) )
     {
@@ -4335,6 +4343,12 @@ void hvm_cpuid(unsigned int input, unsigned int *eax, unsigned int *ebx,
         /* Only provide PSE36 when guest runs in 32bit PAE or in long mode */
         if ( !(hvm_pae_enabled(v) || hvm_long_mode_enabled(v)) )
             *edx &= ~cpufeat_mask(X86_FEATURE_PSE36);
+        /* Fix up NX-disabling HVM param */
+#if CONFIG_PAGING_LEVELS >= 3
+        if ( !v->domain->arch.hvm_domain.params[HVM_PARAM_PAE_ENABLED] ||
+             !v->domain->arch.hvm_domain.params[HVM_PARAM_NX_ENABLED] )
+#endif
+            __clear_bit(X86_FEATURE_NX & 31, edx);
         /* Hide data breakpoint extensions if the hardware has no support. */
         if ( !boot_cpu_has(X86_FEATURE_DBEXT) )
             *ecx &= ~cpufeat_mask(X86_FEATURE_DBEXT);
@@ -5703,6 +5717,10 @@ static int hvmop_set_param(
         hvm_set_callback_via(d, a.value);
         hvm_latch_shinfo_size(d);
         break;
+    case HVM_PARAM_NX_ENABLED:
+        if ( !cpu_has_nx )
+            goto out;
+        break;
     case HVM_PARAM_TIMER_MODE:
         if ( a.value > HVMPTM_one_missed_tick_pending )
             rc = -EINVAL;
diff --git a/xen/include/public/hvm/params.h b/xen/include/public/hvm/params.h
index e940e3d..8c21508 100644
--- a/xen/include/public/hvm/params.h
+++ b/xen/include/public/hvm/params.h
@@ -56,6 +56,7 @@
 
 #if defined(__i386__) || defined(__x86_64__)
 
+#define HVM_PARAM_NX_ENABLED   7
 #define HVM_PARAM_32BIT        8
 
 /*
