From 33fa77dbef61c0aa803b993bce5901ec569a0fcc Mon Sep 17 00:00:00 2001
From: Ross Lagerwall <ross.lagerwall@citrix.com>
Date: Fri, 20 Mar 2015 14:32:04 +0000
Subject: [PATCH 2/2] efi: Ensure incorrectly typed runtime services get mapped

Some firmware implementations do not correctly mark memory needed for runtime
services, not setting the EFI_MEMORY_RUNTIME bit and giving it a type
EfiReservedMemoryType.  Even though EfiReservedMemoryType is not supposed to be
used by the firmware, map these regions so that runtime services work.

The failing firmware implementations were:
    Product Name: PowerEdge R720
    Vendor: Dell Inc.
    Version: 2.1.2
    Release Date: 09/19/2013
    BIOS Revision: 2.1

    Product Name: PowerEdge R320
    Vendor: Dell Inc.
    Version: 1.5.2
    Release Date: 03/11/2013
    BIOS Revision: 1.5

Signed-off-by: Ross Lagerwall <ross.lagerwall@citrix.com>
---
 xen/common/efi/boot.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/xen/common/efi/boot.c b/xen/common/efi/boot.c
index a021d0b..72fc86f 100644
--- a/xen/common/efi/boot.c
+++ b/xen/common/efi/boot.c
@@ -1249,7 +1249,9 @@ void __init efi_init_memory(void)
                desc->PhysicalStart, desc->PhysicalStart + len - 1,
                desc->Type, desc->Attribute);
 
-        if ( !efi_rs_enable || !(desc->Attribute & EFI_MEMORY_RUNTIME) )
+        if ( !efi_rs_enable ||
+             (!(desc->Attribute & EFI_MEMORY_RUNTIME) &&
+              desc->Type != EfiReservedMemoryType) )
             continue;
 
         desc->VirtualStart = INVALID_VIRTUAL_ADDRESS;
-- 
2.1.0

